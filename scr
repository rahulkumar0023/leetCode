#!/bin/bash
input="servers.csv"
output="connection_results.csv"

# Write the header to the output file
echo "servername,port,status" > "$output"

# Read the input CSV and check connection status
while IFS=, read -r server ports; do
    # Remove any potential carriage returns or extra whitespace
    server=$(echo "$server" | tr -d '\r' | xargs)
    ports=$(echo "$ports" | tr -d '\r' | xargs)
    
    echo "Testing server: $server with ports: $ports"
    
    # Split the ports by commas and loop through each one
    IFS=',' read -r -a port_array <<< "$ports"
    
    for port in "${port_array[@]}"; do
        port=$(echo "$port" | xargs)  # Trim port whitespace
        
        echo "Testing $server on port $port"
        nc -zv "$server" "$port" &>/dev/null
        if [[ $? -eq 0 ]]; then
            status="open"
        else
            status="closed"
        fi
        
        # Append the server, port, and status to the output CSV in a single line
        echo "$server,$port,$status" >> "$output"
    done
done < "$input"

echo "Connection results written to $output"
