import javax.xml.bind.JAXBContext;
import javax.xml.bind.Unmarshaller;
import javax.xml.namespace.QName;
import javax.xml.stream.XMLEventReader;
import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.events.XMLEvent;
import java.io.StringReader;

public class SoapMessageProcessor {

    public ParentRequest processSoapMessage(String soapMessage) {
        try {
            // Step 1: Create an XMLInputFactory (for StAX parsing)
            XMLInputFactory factory = XMLInputFactory.newInstance();
            factory.setProperty(XMLInputFactory.IS_NAMESPACE_AWARE, true);

            // Step 2: Create an XMLEventReader for the SOAP message
            XMLEventReader eventReader = factory.createXMLEventReader(new StringReader(soapMessage));

            // Step 3: Navigate to the SOAP Body element
            QName bodyQName = new QName("http://schemas.xmlsoap.org/soap/envelope/", "Body");
            while (eventReader.hasNext()) {
                XMLEvent event = eventReader.nextEvent();
                if (event.isStartElement() && event.asStartElement().getName().equals(bodyQName)) {
                    break;  // Found <soap:Body>
                }
            }

            // Step 4: Move to the <parentRequest> element inside the SOAP Body
            QName parentRequestQName = new QName("", "parentRequest");
            while (eventReader.hasNext()) {
                XMLEvent event = eventReader.nextEvent();
                if (event.isStartElement() && event.asStartElement().getName().equals(parentRequestQName)) {
                    break;  // Found <parentRequest>
                }
            }

            // Step 5: Unmarshal the ParentRequest element (it could be ByNameRequest or ByNumberRequest)
            JAXBContext jaxbContext = JAXBContext.newInstance(ParentRequest.class);
            Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();
            ParentRequest result = (ParentRequest) unmarshaller.unmarshal(eventReader);

            return result;

        } catch (Exception e) {
            e.printStackTrace();
            throw new RuntimeException("Failed to process SOAP message", e);
        }
    }

    public static void main(String[] args) {
        SoapMessageProcessor processor = new SoapMessageProcessor();

        // Example SOAP message with ByNameRequest
        String soapMessage = """
            <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
                <soap:Header/>
                <soap:Body>
                    <parentRequest xsi:type="ByNameRequest" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                        <requestId>12345</requestId>
                        <name>John Doe</name>
                    </parentRequest>
                </soap:Body>
            </soap:Envelope>
            """;

        ParentRequest result = processor.processSoapMessage(soapMessage);
        System.out.println(result);
    }
}
