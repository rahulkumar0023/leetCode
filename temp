FROM registry.access.redhat.com/ubi8/openjdk-17

# Create directory for certificates
RUN mkdir -p /applis/certs

# Copy Keycloak certificate to /applis/certs
COPY keycloak.cer /applis/certs/keycloak.cer

# Ensure JAVA_HOME is set and trust store is writable before importing certificate
RUN export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java)))) && \
    echo "Using JAVA_HOME: $JAVA_HOME" && \
    chmod 644 $JAVA_HOME/lib/security/cacerts && \
    ls -l /applis/certs/keycloak.cer && \
    $JAVA_HOME/bin/keytool -import -trustcacerts -keystore $JAVA_HOME/lib/security/cacerts \
    -storepass changeit -noprompt -alias keycloak -file /applis/certs/keycloak.cer

# Set working directory for the application
WORKDIR /app

# Copy application JAR
COPY target/myapp.jar app.jar
EXPOSE 8080

# Run the application
CMD ["java", "-jar", "app.jar"]
