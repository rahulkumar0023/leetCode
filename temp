# Input and output file paths
$InputFile = "servers.csv"
$OutputFile = "results.csv"

# Write CSV header
"server,port,result,details" | Out-File -Encoding UTF8 $OutputFile

# Read input CSV (skipping header)
$servers = Import-Csv -Path $InputFile

foreach ($entry in $servers) {
    $server = $entry.server.Trim()
    $port = [int]$entry.port

    Write-Host "Testing $server:$port ..."

    try {
        $tcpClient = New-Object System.Net.Sockets.TcpClient
        $async = $tcpClient.BeginConnect($server, $port, $null, $null)
        $wait = $async.AsyncWaitHandle.WaitOne(5000, $false)  # 5 second timeout

        if ($wait -and $tcpClient.Connected) {
            $tcpClient.Close()
            "$server,$port,success,connected" | Out-File -Append -Encoding UTF8 $OutputFile
        }
        else {
            "$server,$port,timeout,no response within 5s" | Out-File -Append -Encoding UTF8 $OutputFile
        }
    }
    catch {
        "$server,$port,error,$($_.Exception.Message)" | Out-File -Append -Encoding UTF8 $OutputFile
    }
}
