import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;
import org.mockito.Mockito;

import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

class SplitAttachmentMoverTest {

    @TempDir
    Path tempDir;

    private Path sourceDir;
    private Path targetDir;

    private PathConfig pathConfig;
    private SplitAttachmentMover mover;

    @BeforeEach
    void setup() throws Exception {
        sourceDir = Files.createDirectory(tempDir.resolve("unzippedXml"));
        targetDir = Files.createDirectory(tempDir.resolve("out"));

        pathConfig = Mockito.mock(PathConfig.class);
        PathConfig.Unzipped unzipped = Mockito.mock(PathConfig.Unzipped.class);

        Mockito.when(pathConfig.getUnzipped()).thenReturn(unzipped);
        Mockito.when(unzipped.getXml()).thenReturn(sourceDir);

        mover = new SplitAttachmentMover(pathConfig);
    }

    @Test
    void moveAttachments_copiesMultipleMatchingAttachments_andRenamesToOutputBase() throws Exception {
        write(sourceDir, "A.xml", "<xml/>");
        write(sourceDir, "A_01.pdf", "pdf1");
        write(sourceDir, "A_02.jpeg", "img2");
        write(sourceDir, "B_01.pdf", "other");

        List<Path> moved = mover.moveAttachments("A", "NEWNAME_INV_123.xml", targetDir);

        assertEquals(2, moved.size());
        assertTrue(Files.exists(targetDir.resolve("NEWNAME_INV_123_01.pdf")));
        assertTrue(Files.exists(targetDir.resolve("NEWNAME_INV_123_02.jpeg")));
        assertFalse(Files.exists(targetDir.resolve("B_01.pdf")));
    }

    @Test
    void moveAttachments_supportsLegacyFormat_baseDotExt() throws Exception {
        write(sourceDir, "A.xml", "<xml/>");
        write(sourceDir, "A.pdf", "legacyPdf");

        List<Path> moved = mover.moveAttachments("A", "OUT.xml", targetDir);

        assertEquals(1, moved.size());
        assertTrue(Files.exists(targetDir.resolve("OUT.pdf"))); // legacy suffix ".pdf"
    }

    @Test
    void moveAttachments_doesNotCopyXmlItself() throws Exception {
        write(sourceDir, "A.xml", "<xml/>");

        List<Path> moved = mover.moveAttachments("A", "OUT.xml", targetDir);

        assertTrue(moved.isEmpty());
        assertFalse(Files.exists(targetDir.resolve("OUT.xml"))); // we never copy XML as attachment
    }

    @Test
    void moveAttachments_matchesCaseInsensitive() throws Exception {
        write(sourceDir, "a.XML", "<xml/>");
        write(sourceDir, "A_01.PDF", "pdf");

        List<Path> moved = mover.moveAttachments("a", "out.xml", targetDir);

        assertEquals(1, moved.size());
        assertTrue(Files.exists(targetDir.resolve("out_01.PDF"))); // preserves original suffix case
    }

    @Test
    void moveAttachments_ignoresNonRegularFiles() throws Exception {
        write(sourceDir, "A.xml", "<xml/>");
        Files.createDirectory(sourceDir.resolve("A_01.pdf")); // directory, not file

        List<Path> moved = mover.moveAttachments("A", "OUT.xml", targetDir);

        assertTrue(moved.isEmpty());
    }

    @Test
    void moveAttachments_createsUniqueNameIfTargetExists() throws Exception {
        write(sourceDir, "A.xml", "<xml/>");
        write(sourceDir, "A_01.pdf", "pdf");

        // pre-create destination to force uniqueIfExists
        write(targetDir, "OUT_01.pdf", "existing");

        List<Path> moved = mover.moveAttachments("A", "OUT.xml", targetDir);

        assertEquals(1, moved.size());
        assertTrue(Files.exists(targetDir.resolve("OUT_01-2.pdf")));
    }

    @Test
    void moveAttachments_returnsEmpty_whenInputsInvalid() {
        assertTrue(mover.moveAttachments("", "OUT.xml", targetDir).isEmpty());
        assertTrue(mover.moveAttachments("A", "", targetDir).isEmpty());
        assertTrue(mover.moveAttachments("A", "OUT.xml", null).isEmpty());
    }

    @Test
    void moveAttachments_returnsEmpty_whenSourceDirMissing() throws Exception {
        Path fileInsteadOfDir = write(tempDir, "notADir.txt", "x");
        PathConfig.Unzipped unzipped = pathConfig.getUnzipped();
        Mockito.when(unzipped.getXml()).thenReturn(fileInsteadOfDir);

        List<Path> moved = mover.moveAttachments("A", "OUT.xml", targetDir);

        assertTrue(moved.isEmpty());
    }

    @Test
    void moveAttachments_handlesIOException_andDoesNotThrow() throws Exception {
        write(sourceDir, "A.xml", "<xml/>");
        write(sourceDir, "A_01.pdf", "pdf");

        // pass a targetDir which is a file -> createDirectories/copy will fail
        Path targetIsFile = write(tempDir, "targetFile", "x");

        assertDoesNotThrow(() -> {
            List<Path> moved = mover.moveAttachments("A", "OUT.xml", targetIsFile);
            assertTrue(moved.isEmpty());
        });
    }

    private static Path write(Path dir, String name, String content) throws Exception {
        Path p = dir.resolve(name);
        Files.writeString(p, content);
        return p;
    }
}
