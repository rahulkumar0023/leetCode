Yep — here’s the **final code** (only what you need), with:

* **VAT 21 subtotal printed once** (tax amount taken **from CSV**, not calculated)
* **VAT 0 subtotal printed once** (taxable = **sum of LineExtensionAmount** for VAT 0)
* **TaxTotal/cbc:TaxAmount is always set** (sum of subtotals)
* **No extra `money()` method**, and **only uses your `toAmount()`**
* No duplicated VAT21/VAT0 methods — **one generic builder**

---

## 1) Mapping change (required)

```java
@Mapping(target = "taxTotal", ignore = true)
InvoiceType toInvoiceType(CsvInvoiceDto dto);
```

---

## 2) Set tax totals once per group (in your existing group method)

```java
default InvoiceType toInvoiceTypeGroup(CsvInvoiceGroup group) {

    CsvInvoiceDto first = group.getRows().get(0);
    InvoiceType invoice = toInvoiceType(first);

    invoice.getInvoiceLine().clear();
    for (CsvInvoiceDto row : group.getRows()) {
        invoice.getInvoiceLine().add(toInvoiceLine(row));
    }

    invoice.getTaxTotal().clear();
    invoice.getTaxTotal().addAll(toTaxTotal(group));

    return invoice;
}
```

---

## 3) Group-level TaxTotal (VAT 21 + VAT 0 once, and TaxTotal TaxAmount set)

```java
default List<TaxTotalType> toTaxTotal(CsvInvoiceGroup group) {

    TaxTotalType taxTotal = new TaxTotalType();
    BigDecimal totalTaxSum = BigDecimal.ZERO;

    TaxSubtotalType vat21 = buildTaxSubtotalForVat(group, new BigDecimal("21"));
    if (vat21 != null) {
        taxTotal.getTaxSubtotal().add(vat21);
        totalTaxSum = totalTaxSum.add(vat21.getTaxAmount().getValue());
    }

    TaxSubtotalType vat0 = buildTaxSubtotalForVat(group, BigDecimal.ZERO);
    if (vat0 != null) {
        taxTotal.getTaxSubtotal().add(vat0);
        totalTaxSum = totalTaxSum.add(vat0.getTaxAmount().getValue());
    }

    if (taxTotal.getTaxSubtotal().isEmpty()) {
        return Collections.emptyList();
    }

    TaxAmountType totalTaxAmount = new TaxAmountType();
    totalTaxAmount.setCurrencyID("EUR");
    totalTaxAmount.setValue(totalTaxSum);
    taxTotal.setTaxAmount(totalTaxAmount);

    return Collections.singletonList(taxTotal);
}
```

---

## 4) One generic subtotal builder (no duplication)

```java
default TaxSubtotalType buildTaxSubtotalForVat(CsvInvoiceGroup group, BigDecimal vatPercentage) {

    BigDecimal taxableSum = BigDecimal.ZERO;
    BigDecimal taxSum = BigDecimal.ZERO;
    boolean foundVat = false;

    for (CsvInvoiceDto row : group.getRows()) {

        BigDecimal vat = toAmount(row.getInvoiceLineCbcVATPercentage());
        if (vat == null || vat.compareTo(vatPercentage) != 0) {
            continue;
        }

        foundVat = true;

        // Taxable base: sum LineExtensionAmount (works for both VAT 21 and VAT 0)
        BigDecimal lineExt = toAmount(row.getInvoiceLineCbcLineExtensionAmount());
        if (lineExt != null) {
            taxableSum = taxableSum.add(lineExt);
        }

        // Tax amount:
        // - VAT 0 => 0
        // - VAT 21 => take VAT amount directly from CSV (no calculations)
        if (vatPercentage.compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal csvVatAmount = toAmount(row.getAdditionalItemPropertyCbcSubTotalVatAmountValue());
            if (csvVatAmount != null) {
                taxSum = taxSum.add(csvVatAmount);
            }
        }
    }

    if (!foundVat) {
        return null;
    }

    TaxSubtotalType taxSubtotal = new TaxSubtotalType();

    TaxableAmountType taxableAmount = new TaxableAmountType();
    taxableAmount.setCurrencyID("EUR");
    taxableAmount.setValue(taxableSum);
    taxSubtotal.setTaxableAmount(taxableAmount);

    TaxAmountType taxAmount = new TaxAmountType();
    taxAmount.setCurrencyID("EUR");
    taxAmount.setValue(taxSum);
    taxSubtotal.setTaxAmount(taxAmount);

    TaxCategoryType taxCategory =
            getTaxCategory(vatPercentage, false, group.getRows().get(0).getItemCbcName());
    taxSubtotal.setTaxCategory(taxCategory);

    return taxSubtotal;
}
```

> Note: This uses `continue;` once. If you want strict Sonar style (“avoid continue”), I can rewrite that if-block into a nested `if` with identical logic.

---

If you paste your existing `getTaxCategory(...)` signature (just that method), I’ll ensure it produces Peppol-correct:

* VAT 21 → `ID=S`, `Percent=21`, `TaxScheme VAT`
* VAT 0 → `ID=E`, `Percent=0`, `TaxScheme VAT` (+ exemption reason if you have it)
