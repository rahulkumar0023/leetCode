You're right! To maintain proper prefixes like `cac`, `cbc` instead of `ns2`, `ns3`, we need to register a custom **`NamespacePrefixMapper`** with the marshaller.

Here's the updated full code with `UBLNamespacePrefixMapper` integrated. This assumes you're using **Glassfish JAXB runtime**, which supports `com.sun.xml.bind.marshaller.NamespacePrefixMapper`.

---

## âœ… `UBLNamespacePrefixMapper.java`

```java
package com.example.batch.util;

import com.sun.xml.bind.marshaller.NamespacePrefixMapper;

public class UBLNamespacePrefixMapper extends NamespacePrefixMapper {

    @Override
    public String getPreferredPrefix(String namespaceUri, String suggestion, boolean requirePrefix) {
        return switch (namespaceUri) {
            case "urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" -> "cac";
            case "urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" -> "cbc";
            case "urn:oasis:names:specification:ubl:schema:xsd:Invoice-2" -> ""; // Default namespace
            default -> suggestion; // fallback
        };
    }
}
```

---

## âœ… Updated `InvoiceWriter.java` (with namespace support)

```java
package com.example.batch.writer;

import com.example.batch.util.UBLNamespacePrefixMapper;
import jakarta.xml.bind.JAXBElement;
import lombok.extern.slf4j.Slf4j;
import network.oxalis.peppol.ubl2.jaxb.InvoiceType;
import org.springframework.batch.item.Chunk;
import org.springframework.batch.item.ItemWriter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.oxm.jaxb.Jaxb2Marshaller;
import org.springframework.stereotype.Component;

import javax.xml.namespace.QName;
import javax.xml.transform.stream.StreamResult;
import java.io.File;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;
import java.util.UUID;

@Slf4j
@Component
public class InvoiceWriter implements ItemWriter<InvoiceType> {

    private final Path xmlDir;
    private final Path pdfDir;
    private final Jaxb2Marshaller marshaller;

    public InvoiceWriter(
            @Value("${invoice.output.xml-dir:/tmp/processed/xml}") String xmlDirPath,
            @Value("${invoice.output.pdf-dir:/tmp/processed/pdf}") String pdfDirPath
    ) {
        this(Path.of(xmlDirPath), Path.of(pdfDirPath));
    }

    // For test injection
    public InvoiceWriter(Path xmlDir, Path pdfDir) {
        this.xmlDir = xmlDir;
        this.pdfDir = pdfDir;
        this.marshaller = new Jaxb2Marshaller();
        this.marshaller.setClassesToBeBound(InvoiceType.class);
        this.marshaller.afterPropertiesSet();

        // Set custom namespace prefix mapper
        this.marshaller.setMarshallerProperties(
                java.util.Map.of(
                        com.sun.xml.bind.marshaller.NamespacePrefixMapper.class.getName(),
                        new UBLNamespacePrefixMapper()
                )
        );
    }

    @Override
    public void write(Chunk<? extends InvoiceType> invoices) throws Exception {
        Files.createDirectories(xmlDir);
        Files.createDirectories(pdfDir);

        for (InvoiceType invoice : invoices) {
            String id = (invoice.getID() != null && invoice.getID().getValue() != null)
                    ? invoice.getID().getValue()
                    : UUID.randomUUID().toString();

            File xmlOut = xmlDir.resolve("invoice-" + id + ".xml").toFile();
            try (FileOutputStream fos = new FileOutputStream(xmlOut)) {
                JAXBElement<InvoiceType> jaxbElement = new JAXBElement<>(
                        new QName("urn:oasis:names:specification:ubl:schema:xsd:Invoice-2", "Invoice"),
                        InvoiceType.class,
                        invoice
                );
                marshaller.marshal(jaxbElement, new StreamResult(fos));
                log.info("âœ… XML written: {}", xmlOut.getAbsolutePath());
            }

            File pdfOut = pdfDir.resolve("invoice-" + id + ".pdf").toFile();
            try (FileWriter fw = new FileWriter(pdfOut)) {
                fw.write("Invoice ID: " + id + "\n(More details...)");
                log.info("ðŸ“„ PDF generated: {}", pdfOut.getAbsolutePath());
            }
        }
    }
}
```

---

âœ… This should eliminate the extra `xmlns:nsX` noise and give you only `cac`, `cbc`, and the default namespace at the root.

Let me know if you're using **Jakarta JAXB 4.0+**, and Iâ€™ll adjust the mapper accordingly using `jakarta.xml.bind.annotation.XmlNs`.

```

---

## âœ… 2. `InvoiceWriterTest.java`

```java
package com.example.batch.writer;

import network.oxalis.peppol.ubl2.jaxb.IDType;
import network.oxalis.peppol.ubl2.jaxb.InvoiceType;
import org.junit.jupiter.api.*;
import org.springframework.batch.item.Chunk;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

class InvoiceWriterTest {

    private Path xmlDir;
    private Path pdfDir;
    private InvoiceWriter writer;

    @BeforeEach
    void setup() throws Exception {
        xmlDir = Files.createTempDirectory("test-xml");
        pdfDir = Files.createTempDirectory("test-pdf");
        writer = new InvoiceWriter(xmlDir, pdfDir);
    }

    @AfterEach
    void cleanup() throws Exception {
        Files.walk(xmlDir).map(Path::toFile).forEach(File::delete);
        Files.walk(pdfDir).map(Path::toFile).forEach(File::delete);
    }

    @Test
    void shouldGenerateXmlAndPdfFiles() throws Exception {
        InvoiceType invoice = new InvoiceType();
        IDType id = new IDType();
        id.setValue("TEST-123");
        invoice.setID(id);

        writer.write(new Chunk<>(List.of(invoice)));

        Path expectedXml = xmlDir.resolve("invoice-TEST-123.xml");
        Path expectedPdf = pdfDir.resolve("invoice-TEST-123.pdf");

        assertTrue(Files.exists(expectedXml), "XML file should exist");
        assertTrue(Files.exists(expectedPdf), "PDF file should exist");
    }
}
```

---

### ðŸ”§ Add this to `application.yml` (optional):

```yaml
invoice:
  output:
    xml-dir: /tmp/processed/xml
    pdf-dir: /tmp/processed/pdf
```

---

Would you like to assert **XML contents** too in the tests? I can help with that next.
