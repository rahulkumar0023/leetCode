FROM registry.access.redhat.com/ubi8/openjdk-17

# Create directory for certificates
RUN mkdir -p /applis/certs

# Copy Keycloak certificate to /applis/certs
COPY keycloak.cer /applis/certs/keycloak.cer

# Ensure the system trusts the new certificate
RUN update-ca-trust extract

# Set JAVA_HOME manually to avoid environment issues at build time
RUN export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java)))) && \
    echo "Using JAVA_HOME: $JAVA_HOME" && \
    ls -l /applis/certs/keycloak.cer && \
    test -f /applis/certs/keycloak.cer && \
    $JAVA_HOME/bin/keytool -import -trustcacerts \
    -keystore $JAVA_HOME/lib/security/cacerts \
    -storepass changeit -noprompt -alias keycloak \
    -file /applis/certs/keycloak.cer || exit 1

# Set working directory for the application
WORKDIR /app

# Copy application JAR
COPY target/myapp.jar app.jar
EXPOSE 8080

# Run the application
CMD ["java", "-jar", "app.jar"]
